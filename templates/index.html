{% extends 'base.html' %} {% block body %}
<style>
  .course-card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
  }
  .course-card:hover {
    transform: translateY(-5px);
  }
  .course-image {
    height: 180px;
    object-fit: cover;
  }
  .course-info {
    padding: 15px;
  }
  .course-price {
    color: #2ecc71;
    font-weight: bold;
    font-size: 1.1rem;
  }
  .course-instructor {
    color: #666;
    font-size: 0.9rem;
  }
</style>

<div class="row m-5">
  <div class="col-md-12">
    <form class="card card-sm">
      <div class="card-body row no-gutters align-items-center">
        <div class="col">
          <input
            type="search"
            name="name"
            placeholder="جستجوی محصولات"
            class="form-control form-control-borderless"
          />
        </div>
        <div class="col-auto me-2">
          <button class="btn btn-primary" type="submit">جستجو</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="row m-5">
  {% for course in courses %}
  <div class="col-md-3 mb-4">
    <div class="card course-card">
      <div class="position-relative">
        <img
          src="/media/{{ course.image }}"
          class="course-image w-100"
          alt="{{ course.name }}"
        />
        <div
          class="position-absolute bottom-0 start-0 end-0 p-2"
          style="
            background: linear-gradient(
              to top,
              rgba(0, 0, 0, 0.8),
              transparent
            );
          "
        >
          <a
            href="{% url 'courses:course_detail' course.slug %}"
            class="text-decoration-none"
          >
            <h5 class="text-white mb-0" id="nm{{ course.id }}">
              {{ course.name }}
            </h5>
          </a>
        </div>
      </div>
      <div class="course-info">
        <div class="d-flex align-items-center mb-2 course-instructor">
          <i class="fas fa-user-tie me-1"></i>
          <span>
            {% if course.teacher %}
              {{ course.teacher.get_full_name|default:course.teacher.username }}
            {% else %}
              مدرسی تعیین نشده است
            {% endif %}
          </span>
        </div>
        <div class="d-flex justify-content-end mb-3">
          <a id="{{ course.id }}" class="btn-like" style="cursor: pointer">
            {% if logged_user in course.liked_by.all %}
            <img
              src="/static/users/images/redheart.png"
              alt="پسندیده شده"
              width="20"
            />
            {% else %}
            <img src="/static/users/images/like.png" alt="پسندیدن" width="20" />
            {% endif %}
          </a>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center">
          <div class="course-price">{{ course.price|floatformat:0 }} تومان</div>
          {% if course.id in purchased_course_ids %}
            <button class="btn btn-success btn-sm" disabled>
              <i class="fas fa-check me-1"></i>
              خریداری شده
            </button>
          {% else %}
            <button id="{{ course.id }}" class="btn btn-primary btn-sm atc">
              <i class="fas fa-shopping-cart me-1"></i>
              افزودن به سبد
            </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
<div class="row">
  <div class="col-md-3 offset-md-4">
    <ul class="pagination justify-content-center">
      {% if courses.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ courses.previous_page_number }}">قبلی</a>
      </li>
      {% endif %}
      <li class="page-item active">
        <a class="page-link" href="?page={{ courses.number }}">{{ courses.number }}</a>
      </li>
      {% if courses.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ courses.next_page_number }}">بعدی</a>
      </li>
      {% endif %}
    </ul>
  </div>
</div>

<!-- Hidden CSRF Token -->
{% csrf_token %} 
{% endblock %} 

{% block script %}
<script type="text/javascript">
  function showAlert(message, type = "success") {
    $(".alert-message").remove();
    const alertDiv = $(`
      <div class="alert alert-${type} alert-dismissible fade show alert-message position-fixed top-0 start-50 translate-middle-x mt-3" role="alert">
        <i class="fas fa-${type === "success" ? "check-circle" : type === "warning" ? "exclamation-triangle" : "times-circle"} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `);
    $("body").append(alertDiv);
    setTimeout(() => alertDiv.alert("close"), 3000);
  }

  function addToCart(courseId) {
    $.ajax({
      url: `/cart/add/${courseId}/`,
      type: "POST",
      headers: {
        "X-CSRFToken": $("[name=csrfmiddlewaretoken]").val(),
      },
      success: function (response) {
        if (response.status === "success") {
          $.get("/cart/count/", function(data) {
            $("#cart-count").text(data.count);
          });
          showAlert("<strong>موفق!</strong> دوره با موفقیت به سبد خرید اضافه شد");
        } else {
          showAlert("<strong>هشدار!</strong> " + response.message, "warning");
        }
      },
      error: function (error) {
        showAlert("<strong>خطا!</strong> خطا در افزودن به سبد خرید", "danger");
      },
    });
  }

  $(document).ready(function () {
    $(".atc").click(function () {
      addToCart($(this).attr("id"));
    });

    window.CSRF_TOKEN = "{{ csrf_token }}";
    $(document).on("click", ".btn-like", function () {
      var $btn = $(this);
      var course_id = this.id;
      $.ajax({
        method: "POST",
        url: "/like",
        data: {
          course_id: course_id,
          csrfmiddlewaretoken: window.CSRF_TOKEN,
        },
        success: function (response) {
          var imgSrc = response.liked
            ? "/static/users/images/redheart.png"
            : "/static/users/images/like.png";
          $btn.find("img").attr("src", imgSrc);
        },
        error: function (xhr) {
          console.error("Error:", xhr.responseText);
        },
      });
    });
  });
</script>

<style>
  .alert-message {
    z-index: 9999;
    min-width: 300px;
    text-align: right;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
</style>
{% endblock %}
