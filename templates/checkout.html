{#{% extends 'base.html' %}#}
{##}
{#{% block body %}#}
{#    <div class="container mt-4">#}
{#    <div class="row">#}
{#        <div class="col-md-12">#}
{#            <ul class="list-group" id="item_list">#}
{#                <!-- Cart items will appear here -->#}
{#            </ul>#}
{#        </div>#}
{#    </div>#}
{#    <div class="row">#}
{#        <div class="col-md-12">#}
{#            <form method="post">#}
{#                {% csrf_token %}#}
{#                <input type="hidden" id="items" name="items">#}
{#                <div class="form-row">#}
{#    <div class="form-group col-md-6">#}
{#      <label for="inputEmail4">Name</label>#}
{#      <input id="name" name="name" type="text" class="form-control"  placeholder="Enter your name">#}
{#    </div>#}
{#    <div class="form-group col-md-6">#}
{#      <label for="inputPassword4">Email</label>#}
{#      <input id="email" name="email" type="text" class="form-control" placeholder="Enter your email">#}
{#    </div>#}
{#  </div>#}
{#  <div class="form-group col-md-6">#}
{#      <label for="total">Ampunt to be paid</label>#}
{#      <input readonly="" class="form-control" id="total" name="total" type="text">#}
{#    </div>#}
{##}
{#              {{ form.as_p }}#}
{#                <button type="submit" class="btn btn-primary">Place Order</button>#}
{#    </div></div>#}
{#            </form>#}
{#        </div>#}
{#    </div>#}
{#</div>#}
{#{% endblock %}#}
{##}
{#{% block script %}#}
{##}
{#    <script type="text/javascript">#}
{#// Fixed cart initialization#}
{#let cart = {};#}
{#try {#}
{#    cart = JSON.parse(localStorage.getItem('cart')) || {};#}
{#} catch (e) {#}
{#    console.error("Error loading cart:", e);#}
{#    localStorage.setItem('cart', JSON.stringify({}));#}
{#}#}
{##}
{#// Fixed jQuery selector and template literal#}
{#function updateCartDisplay() {#}
    {#$('#item_list').empty(); // Clear existing items#}
{#    let total = 0;#}
{#    Object.keys(cart).forEach(itemId => {#}
{#        const item = cart[itemId];#}
{#        total += cart[itemId][2];#}
{##}
{#        const itemString = `#}
{#            <li class="list-group-item d-flex justify-content-between align-items-center">#}
{#                ${item[1]}#}
{#badge bg-primary rounded-pill#}
{#                <span class="badge bg-primary">${item[0]}</span>#}
{#                <span class="badge bg-warning">${item[2]}</span>#}
{#            </li>`;#}
{#        $('#item_list').append(itemString);#}
{#    });#}
{##}
{#    // Add checkout section#}
{#    const totalItems = Object.values(cart).reduce((sum, item) => sum + item[0], 0);#}
{#    const checkoutSection = `#}
{#        <li class="list-group-item bg-light">#}
{#            <div class="d-flex justify-content-between">#}
{#                <strong>Total Items:</strong>#}
{#                <span class="badge bg-success">${totalItems}</span>#}
{#                <span class="badge bg-success">${total}</span>#}
{#            </div>#}
{#            <button class="btn btn-warning w-100 mt-2">#}
{#                Proceed to Checkout#}
{#            </button>#}
{#        </li>`;#}
{##}
{#    $('#item_list').append(checkoutSection);#}
{#    $('#total').val(total);#}
{#}#}
{##}
{#// Initial render#}
{#updateCartDisplay();#}
{##}
{#$('#items').val(JSON.stringify(cart));#}
{##}
{#</script>#}
{##}
{#  <script type="text/javascript">#}
{#    // Initialize cart from localStorage#}
{#    let cart = {};#}
{#    try {#}
{#        cart = JSON.parse(localStorage.getItem('cart')) || {};#}
{#    } catch (e) {#}
{#        console.error("Error loading cart:", e);#}
{#        cart = {};#}
{#    }#}
{##}
{#    // Update navbar cart count immediately#}
{#    document.getElementById("cart").innerHTML = "Cart(" + Object.keys(cart).length + ")";#}
{##}
{#    // Rest of your existing checkout page cart display logic...#}
{#    function updateCartDisplay() {#}
{#        $('#item_list').empty();#}
{#        let total = 0;#}
{##}
{#        Object.keys(cart).forEach(itemId => {#}
{#            const item = cart[itemId];#}
{#            total += item[2]; // Sum all item prices#}
{##}
{#            const itemString = `#}
{#                <li class="list-group-item d-flex justify-content-between align-items-center">#}
{#                    ${item[1]}#}
{#                    <span class="badge bg-primary">${item[0]}</span>#}
{#                    <span class="badge bg-warning">${item[2]}</span>#}
{#                </li>`;#}
{#            $('#item_list').append(itemString);#}
{#        });#}
{##}
{#        // Add total section#}
{#        const totalItems = Object.values(cart).reduce((sum, item) => sum + item[0], 0);#}
{#        const checkoutSection = `#}
{#            <li class="list-group-item bg-light">#}
{#                <div class="d-flex justify-content-between">#}
{#                    <strong>Total Items:</strong>#}
{#                    <span class="badge bg-success">${totalItems}</span>#}
{#                    <span class="badge bg-success">${total}</span>#}
{#                </div>#}
{#            </li>`;#}
{#        $('#item_list').append(checkoutSection);#}
{#        $('#total').val(total);#}
{#    }#}
{##}
{#    // Initial render#}
{#    updateCartDisplay();#}
{#    $('#items').val(JSON.stringify(cart));#}
{#</script>#}
{##}
{#{% endblock %}#}


{% extends 'base.html' %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-group" id="item_list">
                <!-- Cart items will appear here -->
            </ul>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-12">
            <form id="orderForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="items" name="items">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="name">Name</label>
                        <input id="name" name="name" type="text" class="form-control" placeholder="Enter your name" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="email">Email</label>
                        <input id="email" name="email" type="email" class="form-control" placeholder="Enter your email" required>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label for="total">Amount to be paid</label>
                    <input readonly class="form-control" id="total" name="total" type="text">
                </div>
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Place Order</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}

    <script type="text/javascript">
    // Initialize cart from localStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || {};

    // Update navbar cart count
    function updateCartCount() {
        const totalItems = Object.values(cart).reduce((sum, item) => sum + item[0], 0);
        $('#cart').html(`Cart(${totalItems})`);
    }

    // Display cart items with integer prices
    function updateCartDisplay() {
        $('#item_list').empty();
        let total = 0;

        Object.keys(cart).forEach(itemId => {
            const item = cart[itemId];
            total += item[2]; // Sum all item prices

            // Convert price to integer for display
            const displayPrice = parseInt(item[2]);

            const itemString = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item[1]}
                    <span class="badge bg-primary">${item[0]}</span>
                    <span class="badge bg-warning">$${displayPrice}</span>
                </li>`;
            $('#item_list').append(itemString);
        });

        // Display total as integer
        const displayTotal = parseInt(total);
        const totalItems = Object.values(cart).reduce((sum, item) => sum + item[0], 0);

        const checkoutSection = `
            <li class="list-group-item bg-light">
                <div class="d-flex justify-content-between">
                    <strong>Total:</strong>
                    <span class="badge bg-success">${totalItems} items</span>
                    <span class="badge bg-success">$${displayTotal}</span>
                </div>
            </li>`;
        $('#item_list').append(checkoutSection);
        $('#total').val(displayTotal);
        $('#items').val(JSON.stringify(cart));
    }

    // Handle form submission
    $('#orderForm').submit(function(e) {
        e.preventDefault();

        // Basic form validation
        if ($('#name').val() === '' || $('#email').val() === '') {
            alert('Please fill in all required fields');
            return;
        }

        // Submit form via AJAX
        $.ajax({
            type: 'POST',
            url: window.location.pathname,
            data: $(this).serialize(),
            success: function(response) {
                // Clear cart on success
                localStorage.removeItem('cart');
                updateCartCount();

                // Redirect to home page
                window.location.href = "http://127.0.0.1:8000/";
            },
            error: function(xhr) {
                alert('Error placing order: ' + xhr.responseText);
            }
        });
    });

    // Initial setup
    $(document).ready(function() {
        updateCartDisplay();
        updateCartCount();
    });
</script>

{% endblock %}
